<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Gestão de Cursos Profissionalizantes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    // Configuração do Firebase Realtime Database
    const firebaseConfig = {
      apiKey: "AIzaSyAt-qz3cYHSdlRJkdnFo-nSrby_RbWbZMg",
      authDomain: "cursos-17733.firebaseapp.com",
      databaseURL: "https://cursos-17733-default-rtdb.firebaseio.com",
      projectId: "cursos-17733",
      storageBucket: "cursos-17733.firebasestorage.app",
      messagingSenderId: "861985250392",
      appId: "1:861985250392:web:7ac717acbd678b0684be2d",
      measurementId: "G-F2WLBYMHW8"
    };

    // Load Firebase modules
    Promise.all([
      import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'),
      import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'),
      import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js')
    ]).then(([firebaseApp, firebaseAuth, firebaseDatabase]) => {
      // Initialize Firebase
      window.firebaseApp = firebaseApp.initializeApp(firebaseConfig);
      window.firebaseAuth = firebaseAuth.getAuth(window.firebaseApp);
      window.database = firebaseDatabase.getDatabase(window.firebaseApp);
      window.firebaseModules = {
        signInWithEmailAndPassword: firebaseAuth.signInWithEmailAndPassword,
        signOut: firebaseAuth.signOut,
        onAuthStateChanged: firebaseAuth.onAuthStateChanged,
        ref: firebaseDatabase.ref,
        get: firebaseDatabase.get,
        set: firebaseDatabase.set,
        onValue: firebaseDatabase.onValue,
        off: firebaseDatabase.off
      };
      
      // Trigger ready event
      window.dispatchEvent(new Event('firebase-ready'));
    }).catch(error => {
      console.error('Erro ao carregar Firebase:', error);
    });
  </script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            background: '#0a0f1a',
            foreground: '#f8fafc',
            card: '#111827',
            'card-foreground': '#f8fafc',
            primary: '#3b82f6',
            'primary-foreground': '#ffffff',
            secondary: '#1e293b',
            'secondary-foreground': '#f8fafc',
            muted: '#1e293b',
            'muted-foreground': '#94a3b8',
            border: '#1e3a5f',
            input: '#1e293b',
            ring: '#3b82f6',
          }
        }
      }
    }
  </script>
  <style>
    body { 
      background: linear-gradient(135deg, #0a0f1a 0%, #111827 100%);
      color: #f8fafc; 
      min-height: 100vh;
    }
    .modal-overlay { 
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(8px);
    }
    /* Elegant Scrollbar */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { 
      background: rgba(30, 41, 59, 0.3);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb { 
      background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
      border-radius: 10px;
      border: 2px solid rgba(30, 41, 59, 0.3);
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    }
    ::-webkit-scrollbar-thumb:hover { 
      background: linear-gradient(180deg, #2563eb 0%, #1d4ed8 100%);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
    }
    .scrollbar-thin::-webkit-scrollbar { width: 8px; height: 8px; }
    .scrollbar-thin::-webkit-scrollbar-track { 
      background: rgba(30, 41, 59, 0.2);
      border-radius: 10px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb { 
      background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
      border-radius: 10px;
      border: 1px solid rgba(30, 41, 59, 0.3);
      box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
    }
    select option { background: #111827; color: #f8fafc; }
    .tab-btn { transition: all 0.3s ease; }
    .tab-btn.active { 
      border-color: #3b82f6; 
      color: #3b82f6;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    }
    /* Glow effects */
    .glow-border {
      border: 1px solid rgba(59, 130, 246, 0.3);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.1), inset 0 0 15px rgba(59, 130, 246, 0.05);
    }
    .glow-border:hover {
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 0 25px rgba(59, 130, 246, 0.2), inset 0 0 20px rgba(59, 130, 246, 0.1);
    }
    /* Card styling */
    .card-elegant {
      background: rgba(17, 24, 39, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(59, 130, 246, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.1);
    }
    /* Header fixo */
    .header-fixed {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: rgba(17, 24, 39, 0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    /* Header quando modal está aberto */
    body.modal-open .header-fixed {
      background: rgba(10, 15, 26, 0.95);
      backdrop-filter: blur(10px);
      opacity: 0.7;
    }
    /* Mobile optimizations */
    @media (max-width: 768px) {
      /* Desabilitar scrollbar customizada no mobile */
      ::-webkit-scrollbar, .scrollbar-thin::-webkit-scrollbar {
        width: 0px;
        height: 0px;
        display: none;
      }
      /* Inputs com font-size mínimo para evitar zoom no iOS */
      input[type="text"],
      input[type="email"],
      input[type="tel"],
      input[type="password"],
      input[type="number"],
      input[type="date"],
      select,
      textarea {
        font-size: 16px !important;
        min-height: 44px;
      }
      /* Feedback tátil melhorado */
      button:active, .tab-btn:active, a:active {
        transform: scale(0.95);
        opacity: 0.8;
      }
      /* Modais em tela cheia no mobile */
      .modal-content {
        position: absolute !important;
        width: 100vw !important;
        max-width: 100vw !important;
        height: 100vh !important;
        max-height: 100vh !important;
        top: 0 !important;
        left: 0 !important;
        transform: none !important;
        border-radius: 0 !important;
        margin: 0 !important;
      }
      /* Padding reduzido no mobile */
      .container-mobile {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
    }
    @media (min-width: 768px) {
      .modal-content {
        position: absolute !important;
        width: auto !important;
        height: auto !important;
        max-height: 90vh !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        border-radius: 1rem !important;
        margin: 0 !important;
      }
    }
    /* Base para modais - garantir position absolute */
    .modal-content {
      position: absolute;
    }
    /* FAB (Floating Action Button) */
    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 999;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    .fab:active {
      transform: scale(0.9);
    }
    .fab-menu {
      position: fixed;
      bottom: 90px;
      right: 20px;
      z-index: 998;
      display: flex;
      flex-direction: column;
      gap: 12px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }
    .fab-menu.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .fab-item {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    .fab-item:active {
      transform: scale(0.9);
    }
    /* Menu hamburguer */
    .menu-drawer {
      position: fixed;
      top: 0;
      left: -100%;
      width: 280px;
      height: 100vh;
      z-index: 1100;
      background: rgba(17, 24, 39, 0.98);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(59, 130, 246, 0.2);
      transition: left 0.3s ease;
      overflow-y: auto;
    }
    .menu-drawer.open {
      left: 0;
    }
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1099;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .menu-overlay.open {
      opacity: 1;
      visibility: visible;
    }
    /* Alerta de cursos pendentes */
    .alert-pending {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(217, 119, 6, 0.15) 100%);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.1);
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(4px);
      transition: all 0.3s ease;
    }
    .alert-pending:hover {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(217, 119, 6, 0.2) 100%);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
      transform: translateY(-1px);
    }
    .alert-pending .pending-count {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-weight: 700;
      font-size: 10px;
      min-width: 20px;
      text-align: center;
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Loading Screen -->
  <div id="loading-screen" class="fixed inset-0 z-50 bg-background flex items-center justify-center">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-foreground text-lg font-medium">Carregando...</p>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="login-modal" class="fixed inset-0 z-[1100] hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeLoginModal()"></div>
    <div class="modal-content w-full max-w-md md:rounded-2xl card-elegant shadow-2xl overflow-hidden">
      <div class="p-8">
        <div class="text-center mb-8">
          <div class="w-20 h-20 bg-gradient-to-br from-primary to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-primary/30">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
          <h2 class="text-3xl font-bold text-foreground mb-3 bg-gradient-to-r from-primary to-blue-400 bg-clip-text text-transparent">Login Administrativo</h2>
          <p class="text-sm text-muted-foreground">Faça login para acessar funções administrativas</p>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">E-mail</label>
            <input type="email" id="login-email" placeholder="Digite seu e-mail" 
              class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary"
              onkeypress="if(event.key === 'Enter') handleLogin()">
          </div>
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Senha</label>
            <input type="password" id="login-password" placeholder="Digite sua senha" 
              class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary"
              onkeypress="if(event.key === 'Enter') handleLogin()">
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="remember-login" class="w-4 h-4 text-primary bg-input border-border rounded focus:ring-primary">
            <label for="remember-login" class="ml-2 text-sm text-muted-foreground">Manter-me logado</label>
          </div>
          <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-primary to-blue-600 hover:from-blue-600 hover:to-primary text-white px-4 py-3 rounded-xl transition-all duration-300 flex items-center justify-center gap-2 font-medium shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transform hover:-translate-y-0.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
            </svg>
            Entrar
          </button>
        </div>
        <div id="login-error" class="mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-400 text-sm hidden"></div>
      </div>
    </div>
  </div>

  <div id="app" class="hidden">
    <!-- Menu Drawer Mobile -->
    <div class="menu-overlay" id="menu-overlay" onclick="toggleMenuDrawer()"></div>
    <div class="menu-drawer" id="menu-drawer">
      <div class="p-6 border-b border-border/30">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-foreground">Menu</h2>
          <button onclick="toggleMenuDrawer()" class="p-2 hover:bg-secondary/50 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="space-y-2">
          <button onclick="switchTab('dashboard'); toggleMenuDrawer();" class="tab-btn active w-full text-left flex items-center gap-3 px-4 py-3 border-l-4 border-transparent hover:bg-secondary/50 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
            Dashboard
          </button>
          <button onclick="switchTab('settings'); toggleMenuDrawer();" id="tab-settings-mobile" class="tab-btn admin-only w-full text-left flex items-center gap-3 px-4 py-3 border-l-4 border-transparent hover:bg-secondary/50 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31 .826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Configurações
          </button>
          <button onclick="handleLogout(); toggleMenuDrawer();" id="logout-btn-mobile" class="admin-only w-full text-left flex items-center gap-3 px-4 py-3 text-red-400 hover:bg-red-500/20 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Sair
          </button>
          <button onclick="openLoginModal(); toggleMenuDrawer();" id="login-btn-mobile" class="view-only w-full text-left flex items-center gap-3 px-4 py-3 bg-primary/20 hover:bg-primary/30 text-primary rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            Login
          </button>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header class="header-fixed border-b border-border">
      <div class="container mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <!-- Botão Hambúrguer (Mobile) -->
          <button onclick="toggleMenuDrawer()" class="md:hidden p-2 hover:bg-secondary/50 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
          <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
          </div>
          <div class="hidden sm:block">
            <h1 class="text-xl font-bold text-foreground">Gestão de Cursos</h1>
            <p class="text-sm text-muted-foreground">Cursos Profissionalizantes por Lote</p>
          </div>
          <div class="sm:hidden">
            <h1 class="text-lg font-bold text-foreground">Gestão de Cursos</h1>
        </div>
        </div>
        <!-- Botões Desktop -->
        <div class="hidden md:flex items-center gap-2">
          <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn active flex items-center gap-2 px-4 py-2 border-b-2 border-transparent hover:text-primary transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
            Dashboard
          </button>
          <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn admin-only flex items-center gap-2 px-4 py-2 border-b-2 border-transparent hover:text-primary transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31 .826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Configurações
          </button>
          <button onclick="handleLogout()" id="logout-btn" class="admin-only flex items-center gap-2 px-4 py-2 text-red-400 hover:bg-red-500/20 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Sair
          </button>
          <button onclick="openLoginModal()" id="login-btn" class="view-only flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            Login
          </button>
        </div>
      </div>
    </header>

    <!-- Dashboard Tab Content -->
    <main id="content-dashboard" class="container mx-auto px-2 md:px-4 py-6 space-y-6">
      <!-- Action Buttons (Desktop) -->
      <div class="admin-only hidden md:flex flex-wrap gap-3">
        <button onclick="openImportModal()" class="flex items-center gap-2 bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
          </svg>
          Importar Planilha
        </button>
        <button onclick="openAddCourseModal()" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Adicionar Curso
        </button>
      </div>

      <!-- FAB Menu (Mobile) -->
      <div class="admin-only md:hidden">
        <div id="fab-menu" class="fab-menu">
          <button onclick="openImportModal(); toggleFABMenu();" class="fab-item bg-primary text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
          </button>
          <button onclick="openAddCourseModal(); toggleFABMenu();" class="fab-item bg-green-600 text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
          </button>
        </div>
        <button onclick="toggleFABMenu()" class="fab bg-gradient-to-r from-primary to-blue-600 text-white">
          <svg id="fab-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          <svg id="fab-close-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Stats Cards -->
      <div id="stats-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>

      <!-- Filters -->
      <div class="card-elegant rounded-2xl p-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Buscar Tipologia</label>
            <input type="text" id="filter-search" placeholder="Digite para buscar..." 
              class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary" 
              oninput="applyFilters()">
          </div>
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Lote</label>
            <select id="filter-lote" class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary" onchange="applyFilters()">
              <option value="">Todos os Lotes</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Município</label>
            <select id="filter-municipio" class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary" onchange="applyFilters()">
              <option value="">Todos os Municípios</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Status</label>
            <select id="filter-status" class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary" onchange="applyFilters()">
              <option value="">Todos os Status</option>
              <option value="Concluído">Concluído</option>
              <option value="Pendente">Pendente</option>
              <option value="Em andamento">Em andamento</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Lot Sections -->
      <div id="lot-sections" class="space-y-6"></div>
    </main>

    <!-- Settings Tab Content -->
    <main id="content-settings" class="container mx-auto px-2 md:px-4 py-6 space-y-6 hidden">
      <div class="bg-card border border-border rounded-lg p-6">
        <h2 class="text-xl font-semibold text-foreground mb-6">Configurações</h2>
        
        <!-- Backup e Restauração -->
        <div class="border border-primary/30 rounded-lg p-4 bg-primary/5 mb-6">
          <h3 class="text-lg font-medium text-foreground mb-2">Backup e Restauração</h3>
          <p class="text-sm text-muted-foreground mb-4">Faça backup dos seus dados ou restaure de um backup anterior.</p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex items-center justify-between p-4 bg-secondary/30 rounded-lg">
              <div>
                <p class="font-medium text-foreground">Fazer Backup</p>
                <p class="text-sm text-muted-foreground">Exporta todos os cursos e responsáveis para um arquivo JSON.</p>
              </div>
              <button onclick="exportBackup()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Exportar
              </button>
            </div>
            
            <div class="flex items-center justify-between p-4 bg-secondary/30 rounded-lg">
              <div>
                <p class="font-medium text-foreground">Restaurar Backup</p>
                <p class="text-sm text-muted-foreground">Importa dados de um arquivo JSON de backup.</p>
              </div>
              <button onclick="openRestoreModal()" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Importar
              </button>
            </div>
          </div>
        </div>
        
        <div class="border border-red-500/30 rounded-lg p-4 bg-red-500/5">
          <h3 class="text-lg font-medium text-red-400 mb-2">Zona de Perigo</h3>
          <p class="text-sm text-muted-foreground mb-4">Ações irreversíveis. Tenha cuidado ao executar.</p>
          
          <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-secondary/30 rounded-lg">
              <div>
                <p class="font-medium text-foreground">Excluir Todos os Cursos</p>
                <p class="text-sm text-muted-foreground">Remove todos os cursos cadastrados no sistema.</p>
              </div>
              <button onclick="deleteAllCourses()" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Excluir Cursos
              </button>
            </div>
            
            <div class="flex items-center justify-between p-4 bg-secondary/30 rounded-lg">
              <div>
                <p class="font-medium text-foreground">Excluir Todos os Responsáveis</p>
                <p class="text-sm text-muted-foreground">Remove todos os responsáveis de todos os lotes.</p>
              </div>
              <button onclick="deleteAllResponsibles()" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Excluir Responsáveis
              </button>
            </div>
            
            <div class="flex items-center justify-between p-4 bg-secondary/30 rounded-lg border border-red-500/50">
              <div>
                <p class="font-medium text-red-400">Excluir Todos os Dados</p>
                <p class="text-sm text-muted-foreground">Remove todos os cursos e responsáveis do sistema.</p>
              </div>
              <button onclick="deleteAllData()" class="flex items-center gap-2 bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                Excluir Tudo
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Import Modal -->
  <div id="import-modal" class="fixed inset-0 z-[1100] hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeImportModal()"></div>
    <div class="modal-content w-full max-w-3xl max-h-[90vh] bg-card border border-border md:rounded-lg shadow-xl overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b border-border">
        <div>
          <h2 class="text-lg font-semibold text-foreground">Importação Inteligente de Planilha</h2>
          <p class="text-sm text-muted-foreground">Mapeie as colunas da sua planilha</p>
        </div>
        <button onclick="closeImportModal()" class="p-2 hover:bg-secondary rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-4 overflow-y-auto max-h-[70vh] scrollbar-thin">
        <!-- Step 1: Upload -->
        <div id="import-step-1">
          <div class="flex items-center gap-2 mb-4">
            <span class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm font-medium">1</span>
            <span class="text-foreground font-medium">Selecione o arquivo</span>
          </div>
          <div class="border-2 border-dashed border-border rounded-lg p-8 text-center hover:border-primary transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto text-muted-foreground mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <p class="text-muted-foreground mb-2">Arraste e solte seu arquivo aqui ou</p>
            <input type="file" id="file-input" accept=".csv,.xlsx,.xls" class="hidden" onchange="handleFileUpload(event)">
            <button onclick="document.getElementById('file-input').click()" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-colors">
              Selecionar Arquivo
            </button>
            <p class="text-xs text-muted-foreground mt-2">Formatos suportados: CSV, XLSX, XLS</p>
          </div>
        </div>

        <!-- Step 2: Mapping -->
        <div id="import-step-2" class="hidden">
          <div class="flex items-center gap-2 mb-4">
            <span class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm font-medium">2</span>
            <span class="text-foreground font-medium">Mapeamento de Colunas</span>
          </div>
          <p class="text-sm text-muted-foreground mb-4">Associe as colunas da sua planilha aos campos do sistema:</p>
          <div id="mapping-fields" class="space-y-3"></div>
          <div class="flex justify-between mt-6">
            <button onclick="backToStep1()" class="px-4 py-2 border border-border text-foreground rounded-lg hover:bg-secondary transition-colors">
              Voltar
            </button>
            <button onclick="goToStep3()" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-colors">
              Pré-visualizar
            </button>
          </div>
        </div>

        <!-- Step 3: Preview -->
        <div id="import-step-3" class="hidden">
          <div class="flex items-center gap-2 mb-4">
            <span class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm font-medium">3</span>
            <span class="text-foreground font-medium">Pré-visualização</span>
          </div>
          <p class="text-sm text-muted-foreground mb-4">Confira os dados antes de importar (primeiros 5 registros):</p>
          <div class="overflow-x-auto">
            <table id="preview-table" class="w-full text-sm"></table>
          </div>
          <div class="flex justify-between mt-6">
            <button onclick="backToStep2()" class="px-4 py-2 border border-border text-foreground rounded-lg hover:bg-secondary transition-colors">
              Voltar
            </button>
            <button onclick="confirmImport()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
              Confirmar Importação
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Responsibles Modal -->
  <div id="responsibles-modal" class="fixed inset-0 z-[1100] hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeResponsiblesModal()"></div>
    <div class="modal-content w-full max-w-lg max-h-[90vh] bg-card border border-border md:rounded-lg shadow-xl overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b border-border">
        <div>
          <h2 class="text-lg font-semibold text-foreground">Responsáveis do <span id="modal-lot-name"></span></h2>
          <p class="text-sm text-muted-foreground">Gerencie os responsáveis deste lote</p>
        </div>
        <button onclick="closeResponsiblesModal()" class="p-2 hover:bg-secondary rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-4 overflow-y-auto max-h-[60vh] scrollbar-thin">
        <!-- Informações Adicionais dos Cursos -->
        <div id="lot-course-info" class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-4">
          <h3 class="text-sm font-medium text-foreground mb-3">Informações dos Cursos do Lote</h3>
          <div id="lot-course-info-content" class="space-y-2 text-sm text-muted-foreground">
            <!-- Informações serão carregadas aqui -->
          </div>
        </div>
        
        <div id="add-responsible-section" class="bg-secondary/50 border border-border rounded-lg p-4 mb-4">
          <h3 class="text-sm font-medium text-foreground mb-3">Adicionar Responsável</h3>
          <div class="space-y-3">
            <input type="text" id="resp-name" placeholder="Nome completo" 
              class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
            <input type="text" id="resp-cargo" placeholder="Cargo" 
              class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
            <input type="tel" id="resp-phone" placeholder="Telefone (ex: 5511999999999)" 
              class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
            <button onclick="addResponsible()" class="w-full bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Adicionar
            </button>
          </div>
        </div>

        <div id="responsibles-list" class="space-y-3"></div>

        <div id="delete-lot-section" class="mt-6 pt-4 border-t border-border">
          <button onclick="deleteLot()" class="w-full flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Excluir Lote Inteiro
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Restore Backup Modal -->
  <div id="restore-modal" class="fixed inset-0 z-[1100] hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeRestoreModal()"></div>
    <div class="modal-content w-full max-w-md bg-card border border-border md:rounded-lg shadow-xl overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b border-border">
        <div>
          <h2 class="text-lg font-semibold text-foreground">Restaurar Backup</h2>
          <p class="text-sm text-muted-foreground">Importe um arquivo JSON de backup</p>
        </div>
        <button onclick="closeRestoreModal()" class="p-2 hover:bg-secondary rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium text-muted-foreground mb-2">Selecione o arquivo de backup</label>
          <input type="file" id="restore-file-input" accept=".json" 
            class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary">
          <p class="text-xs text-muted-foreground mt-2">Formatos suportados: JSON</p>
        </div>
        
        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
          <p class="text-sm font-medium text-yellow-400 mb-2">⚠️ Atenção</p>
          <div class="space-y-2">
            <label class="flex items-center">
              <input type="radio" name="restore-mode" value="replace" checked class="w-4 h-4 text-primary bg-input border-border rounded focus:ring-primary">
              <span class="ml-2 text-sm text-foreground">Substituir todos os dados (apaga dados existentes)</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="restore-mode" value="merge" class="w-4 h-4 text-primary bg-input border-border rounded focus:ring-primary">
              <span class="ml-2 text-sm text-foreground">Mesclar dados (adiciona aos dados existentes)</span>
            </label>
          </div>
        </div>
        
        <div id="restore-preview" class="hidden bg-secondary/50 border border-border rounded-lg p-3">
          <p class="text-sm font-medium text-foreground mb-2">Pré-visualização do backup:</p>
          <div id="restore-preview-content" class="text-xs text-muted-foreground"></div>
        </div>
        
        <div id="restore-error" class="hidden p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-400 text-sm"></div>
        
        <div class="flex justify-end gap-3">
          <button onclick="closeRestoreModal()" class="px-4 py-2 border border-border text-foreground rounded-lg hover:bg-secondary transition-colors">
            Cancelar
          </button>
          <button onclick="confirmRestore()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Restaurar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Course Modal -->
  <div id="add-course-modal" class="fixed inset-0 z-[1100] hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeAddCourseModal(event)"></div>
    <div class="modal-content w-full max-w-lg max-h-[90vh] bg-card border border-border md:rounded-lg shadow-xl overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b border-border">
        <div>
          <h2 class="text-lg font-semibold text-foreground">Adicionar Novo Curso</h2>
          <p class="text-sm text-muted-foreground">Preencha os dados do curso</p>
        </div>
        <button onclick="closeAddCourseModal()" class="p-2 hover:bg-secondary rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-4 overflow-y-auto max-h-[70vh] scrollbar-thin space-y-4">
        <!-- Added ID field to add course modal -->
        <div>
          <label class="block text-sm font-medium text-muted-foreground mb-2">ID do Curso</label>
          <input type="text" id="course-id" placeholder="Ex: CURSO-001" 
            class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div>
          <label class="block text-sm font-medium text-muted-foreground mb-2">Tipologia *</label>
          <input type="text" id="course-tipologia" placeholder="Ex: Técnico em Informática" 
            class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Carga Horária *</label>
            <input type="number" id="course-carga" placeholder="Ex: 1200" 
              class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Lote *</label>
            <input type="number" id="course-lote" placeholder="Ex: 1" 
              class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Data Início</label>
            <input type="date" id="course-inicio" 
              class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Data Fim</label>
            <input type="date" id="course-fim" 
              class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-muted-foreground mb-2">Município *</label>
          <input type="text" id="course-municipio" placeholder="Ex: São Paulo" 
            class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div>
          <label class="block text-sm font-medium text-muted-foreground mb-2">Cozinha</label>
          <input type="text" id="course-cozinha" placeholder="Ex: Cozinha 1" 
            class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Status</label>
            <select id="course-status" class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="Pendente">Pendente</option>
              <option value="Em andamento">Em andamento</option>
              <option value="Concluído">Concluído</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">Concludentes</label>
            <input type="number" id="course-concludentes" placeholder="Ex: 30" 
              class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
        </div>
        <button onclick="saveCourse()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition-colors flex items-center justify-center gap-2 mt-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Salvar Curso
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Course Modal -->
  <div id="edit-course-modal" class="fixed inset-0 z-[1100] hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeEditCourseModal(event)"></div>
    <div class="modal-content w-full max-w-2xl max-h-[90vh] card-elegant md:rounded-2xl shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between p-6 border-b border-border/30">
        <div>
          <h2 class="text-2xl font-semibold text-foreground">Detalhes do Curso</h2>
          <p class="text-sm text-muted-foreground mt-1">Visualize e edite as informações do curso</p>
        </div>
        <button onclick="closeEditCourseModal()" class="p-2 hover:bg-secondary/50 rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-6 overflow-y-auto max-h-[70vh] scrollbar-thin space-y-6">
        <!-- Informações do Curso (Somente Leitura) -->
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">ID do Curso</label>
              <div class="px-3 py-2 bg-secondary/30 border border-border/50 rounded-lg text-foreground font-mono text-sm" id="edit-course-id">-</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">Tipologia</label>
              <div class="px-3 py-2 bg-secondary/30 border border-border/50 rounded-lg text-foreground" id="edit-course-tipologia">-</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">Carga Horária</label>
              <div class="px-3 py-2 bg-secondary/30 border border-border/50 rounded-lg text-foreground" id="edit-course-carga">-</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">Lote</label>
              <div class="px-3 py-2 bg-secondary/30 border border-border/50 rounded-lg text-foreground" id="edit-course-lote">-</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">Município</label>
              <div class="px-3 py-2 bg-secondary/30 border border-border/50 rounded-lg text-foreground" id="edit-course-municipio">-</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">Cozinha</label>
              <div class="px-3 py-2 bg-secondary/30 border border-border/50 rounded-lg text-foreground" id="edit-course-cozinha">-</div>
            </div>
          </div>
        </div>

        <!-- Campos Editáveis (Apenas para usuários logados) -->
        <div id="edit-course-editable-section" class="border-t border-border/30 pt-6 hidden">
          <h3 class="text-lg font-semibold text-foreground mb-4">Editar Informações</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">Data Início *</label>
              <input type="date" id="edit-course-inicio" 
                class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">Data Fim *</label>
              <input type="date" id="edit-course-fim" 
                class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">Status *</label>
              <select id="edit-course-status" class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="Pendente">Pendente</option>
                <option value="Em andamento">Em andamento</option>
                <option value="Concluído">Concluído</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">Concludentes</label>
              <input type="number" id="edit-course-concludentes" placeholder="Ex: 30" 
                class="w-full px-3 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
          </div>
        </div>

        <div id="edit-course-actions" class="flex justify-end gap-3 pt-4 border-t border-border/30 hidden">
          <button onclick="closeEditCourseModal()" class="px-4 py-2 border border-border text-foreground rounded-lg hover:bg-secondary/50 transition-colors">
            Cancelar
          </button>
          <button onclick="saveEditedCourse()" class="px-4 py-2 bg-gradient-to-r from-primary to-blue-600 hover:from-blue-600 hover:to-primary text-white rounded-lg transition-all duration-300 flex items-center gap-2 shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Salvar Alterações
          </button>
        </div>
        
        <div id="edit-course-view-only" class="flex justify-end gap-3 pt-4 border-t border-border/30">
          <button onclick="closeEditCourseModal()" class="px-4 py-2 border border-border text-foreground rounded-lg hover:bg-secondary/50 transition-colors">
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    
    const STORAGE_KEY_COURSES = 'dashboard_courses';
    const STORAGE_KEY_RESPONSIBLES = 'dashboard_responsibles';

    // Load data - will be loaded from Firestore
    let courses = [];
    let lotResponsibles = {};
    let filteredCourses = [];
    let dataMigrationDone = false;
    
    let currentEditLot = null;
    let currentEditCourse = null;
    let uploadedData = [];
    let fileColumns = [];
    let columnMapping = {};
    let isLoggedIn = false;
    let firebaseAuth = null;
    let unsubscribeCourses = null;
    let unsubscribeResponsibles = null;

    const fieldLabels = {
      idCurso: 'ID do Curso',
      tipologia: 'Tipologia',
      cargaHoraria: 'Carga Horária',
      dataInicio: 'Data Início',
      dataFim: 'Data Fim',
      municipio: 'Município',
      lote: 'Lote',
      status: 'Status',
      concludentes: 'Concludentes',
      cozinha: 'Cozinha'
    };

    async function saveToRealtimeDatabase() {
      if (isUpdatingFromListener) {
        console.log('Ignorando salvamento - atualização vinda do listener');
        return; // Prevent infinite loop
      }
      
      if (!window.database || !window.firebaseModules) {
        console.warn('Realtime Database não disponível, usando localStorage como fallback');
        localStorage.setItem(STORAGE_KEY_COURSES, JSON.stringify(courses));
        localStorage.setItem(STORAGE_KEY_RESPONSIBLES, JSON.stringify(lotResponsibles));
        return;
      }

      try {
        const db = window.database;
        const { ref, set } = window.firebaseModules;
        
        console.log('Salvando no Realtime Database...', { courses: courses.length, responsibles: Object.keys(lotResponsibles).length });
        
        // Save courses
        await set(ref(db, 'courses'), courses);
        console.log('Cursos salvos no Realtime Database com sucesso');
        
        // Save responsibles
        await set(ref(db, 'responsibles'), lotResponsibles);
        console.log('Responsáveis salvos no Realtime Database com sucesso');
        
        // Update last sync timestamp
        await set(ref(db, 'lastSync'), new Date().toISOString());
      } catch (error) {
        console.error('Erro ao salvar no Realtime Database:', error);
        
        // Show user-friendly error
        if (error.code === 'PERMISSION_DENIED') {
          alert('Erro de permissão no Realtime Database. Verifique as regras de segurança no Firebase Console.');
        }
        
        // Fallback to localStorage
        localStorage.setItem(STORAGE_KEY_COURSES, JSON.stringify(courses));
        localStorage.setItem(STORAGE_KEY_RESPONSIBLES, JSON.stringify(lotResponsibles));
      }
    }

    // Alias for compatibility - make sure to await this when needed
    async function saveToStorage() {
      await saveToRealtimeDatabase();
    }

    async function loadFromRealtimeDatabase() {
      // Always load from localStorage first (as fallback)
      const localCourses = JSON.parse(localStorage.getItem(STORAGE_KEY_COURSES)) || [];
      const localResponsibles = JSON.parse(localStorage.getItem(STORAGE_KEY_RESPONSIBLES)) || {};
      courses = localCourses;
      lotResponsibles = localResponsibles;
      filteredCourses = [...courses];
      
      if (!window.database || !window.firebaseModules) {
        console.warn('Realtime Database não disponível, usando localStorage');
        renderAll();
        return;
      }

      try {
        const db = window.database;
        const { ref, get } = window.firebaseModules;
        
        // Try to load courses from Realtime Database with timeout
        const coursesPromise = get(ref(db, 'courses'));
        const coursesTimeout = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout ao carregar cursos')), 10000)
        );
        
        const coursesSnapshot = await Promise.race([coursesPromise, coursesTimeout]);
        
        if (coursesSnapshot.exists()) {
          const dbCourses = coursesSnapshot.val() || [];
          if (Array.isArray(dbCourses) && dbCourses.length > 0) {
            courses = dbCourses;
            // Update localStorage as backup
            localStorage.setItem(STORAGE_KEY_COURSES, JSON.stringify(courses));
          }
        } else {
          // No data in Realtime Database, migrate from localStorage if exists
          if (localCourses.length > 0 && !dataMigrationDone) {
            console.log('Migrando dados do localStorage para Realtime Database...');
            await saveToRealtimeDatabase();
            dataMigrationDone = true;
          }
        }
        
        // Try to load responsibles from Realtime Database with timeout
        const responsiblesPromise = get(ref(db, 'responsibles'));
        const responsiblesTimeout = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout ao carregar responsáveis')), 10000)
        );
        
        const responsiblesSnapshot = await Promise.race([responsiblesPromise, responsiblesTimeout]);
        
        if (responsiblesSnapshot.exists()) {
          const dbResponsibles = responsiblesSnapshot.val() || {};
          if (Object.keys(dbResponsibles).length > 0) {
            lotResponsibles = dbResponsibles;
            // Update localStorage as backup
            localStorage.setItem(STORAGE_KEY_RESPONSIBLES, JSON.stringify(lotResponsibles));
          }
        } else {
          // No data in Realtime Database, migrate from localStorage if exists
          if (Object.keys(localResponsibles).length > 0 && !dataMigrationDone) {
            await saveToRealtimeDatabase();
            dataMigrationDone = true;
          }
        }
        
        filteredCourses = [...courses];
        console.log('✅ Dados carregados do Realtime Database com sucesso');
      } catch (error) {
        console.warn('⚠️ Erro ao carregar do Realtime Database (usando localStorage):', error.code || error.message);
        
        // Keep using localStorage data (already loaded above)
      }
      
      renderAll();
    }

    let isUpdatingFromListener = false;

    function setupRealtimeListeners() {
      if (!window.database || !window.firebaseModules) {
        // Fallback to localStorage sync (manual refresh needed)
        console.warn('Realtime Database não disponível, sincronização em tempo real desabilitada');
        return;
      }
      
      const db = window.database;
      const { ref, onValue, off } = window.firebaseModules;
      
      console.log('Configurando listeners em tempo real do Realtime Database...');
      
      // Unsubscribe from previous listeners if any
      if (unsubscribeCourses && typeof unsubscribeCourses === 'function') {
        unsubscribeCourses();
      }
      if (unsubscribeResponsibles && typeof unsubscribeResponsibles === 'function') {
        unsubscribeResponsibles();
      }
      
      try {
        // Listen to courses changes
        const coursesRef = ref(db, 'courses');
        const coursesCallback = (snapshot) => {
            if (snapshot.exists() && !isUpdatingFromListener) {
            const newCourses = snapshot.val() || [];
              const currentStr = JSON.stringify(courses.sort((a, b) => (a.id || '').localeCompare(b.id || '')));
              const newStr = JSON.stringify(newCourses.sort((a, b) => (a.id || '').localeCompare(b.id || '')));
              
              if (currentStr !== newStr) {
                console.log('🔄 Atualizando cursos via listener em tempo real', { oldCount: courses.length, newCount: newCourses.length });
                isUpdatingFromListener = true;
                courses = newCourses;
                filteredCourses = [...courses];
                // Update localStorage as backup
                localStorage.setItem(STORAGE_KEY_COURSES, JSON.stringify(courses));
                updateFilters();
                applyFilters();
                setTimeout(() => { isUpdatingFromListener = false; }, 100);
              }
            }
        };
        onValue(coursesRef, coursesCallback, (error) => {
            console.warn('⚠️ Erro no listener de courses (sincronização em tempo real desabilitada):', error.code || error.message);
          if (error.code === 'PERMISSION_DENIED') {
            console.warn('Permissão negada no Realtime Database. Verifique as regras de segurança.');
          }
        });
        // Store unsubscribe function
        unsubscribeCourses = () => off(coursesRef, 'value', coursesCallback);
        
        // Listen to responsibles changes
        const responsiblesRef = ref(db, 'responsibles');
        const responsiblesCallback = (snapshot) => {
            if (snapshot.exists() && !isUpdatingFromListener) {
            const newResponsibles = snapshot.val() || {};
              const currentStr = JSON.stringify(lotResponsibles);
              const newStr = JSON.stringify(newResponsibles);
              
              if (currentStr !== newStr) {
                console.log('🔄 Atualizando responsáveis via listener em tempo real');
                isUpdatingFromListener = true;
                lotResponsibles = newResponsibles;
                // Update localStorage as backup
                localStorage.setItem(STORAGE_KEY_RESPONSIBLES, JSON.stringify(lotResponsibles));
                renderAll();
                setTimeout(() => { isUpdatingFromListener = false; }, 100);
              }
            }
        };
        onValue(responsiblesRef, responsiblesCallback, (error) => {
            console.warn('⚠️ Erro no listener de responsibles (sincronização em tempo real desabilitada):', error.code || error.message);
          if (error.code === 'PERMISSION_DENIED') {
            console.warn('Permissão negada no Realtime Database. Verifique as regras de segurança.');
          }
        });
        // Store unsubscribe function
        unsubscribeResponsibles = () => off(responsiblesRef, 'value', responsiblesCallback);
        
        console.log('✅ Listeners em tempo real configurados com sucesso');
      } catch (error) {
        console.error('Erro ao configurar listeners:', error);
      }
    }

    // Firebase Authentication
    async function checkFirebaseAuth() {
      try {
        if (window.firebaseAuth && window.firebaseModules) {
          return new Promise((resolve) => {
            window.firebaseModules.onAuthStateChanged(window.firebaseAuth, (user) => {
              isLoggedIn = !!user;
              updateUIForLoginStatus();
              renderAll();
              resolve(!!user);
            });
          });
        }
      } catch (error) {
        console.error('Erro ao verificar autenticação Firebase:', error);
        isLoggedIn = false;
        return false;
      }
      return false;
    }

    function updateUIForLoginStatus() {
      const adminElements = document.querySelectorAll('.admin-only');
      const viewElements = document.querySelectorAll('.view-only');
      
      // Update responsibles modal sections
      const addRespSection = document.getElementById('add-responsible-section');
      const deleteLotSection = document.getElementById('delete-lot-section');
      
      // Update mobile menu drawer buttons
      const tabSettingsMobile = document.getElementById('tab-settings-mobile');
      const logoutBtnMobile = document.getElementById('logout-btn-mobile');
      const loginBtnMobile = document.getElementById('login-btn-mobile');
      
      if (isLoggedIn) {
        // Show admin elements, hide view-only elements
        adminElements.forEach(el => {
          el.classList.remove('hidden');
          el.style.display = '';
        });
        viewElements.forEach(el => {
          el.classList.add('hidden');
          el.style.display = 'none';
        });
        
        // Show modal admin sections
        if (addRespSection) addRespSection.style.display = 'block';
        if (deleteLotSection) deleteLotSection.style.display = 'block';
        
        // Update mobile menu
        if (tabSettingsMobile) tabSettingsMobile.classList.remove('hidden');
        if (logoutBtnMobile) logoutBtnMobile.classList.remove('hidden');
        if (loginBtnMobile) loginBtnMobile.classList.add('hidden');
      } else {
        // Hide admin elements, show view-only elements
        adminElements.forEach(el => {
          el.classList.add('hidden');
          el.style.display = 'none';
        });
        viewElements.forEach(el => {
          el.classList.remove('hidden');
          el.style.display = '';
        });
        
        // Hide modal admin sections
        if (addRespSection) addRespSection.style.display = 'none';
        if (deleteLotSection) deleteLotSection.style.display = 'none';
        
        // Update mobile menu
        if (tabSettingsMobile) tabSettingsMobile.classList.add('hidden');
        if (logoutBtnMobile) logoutBtnMobile.classList.add('hidden');
        if (loginBtnMobile) loginBtnMobile.classList.remove('hidden');
      }
    }

    function openLoginModal() {
      document.getElementById('login-modal').classList.remove('hidden');
      document.getElementById('login-error').classList.add('hidden');
      document.getElementById('login-email').value = '';
      document.getElementById('login-password').value = '';
      document.body.classList.add('modal-open');
    }

    function closeLoginModal() {
      document.getElementById('login-modal').classList.add('hidden');
      document.body.classList.remove('modal-open');
    }

    async function handleLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const remember = document.getElementById('remember-login')?.checked || false;
      const errorDiv = document.getElementById('login-error');

      if (!email || !password) {
        errorDiv.textContent = 'Por favor, preencha todos os campos.';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        if (!window.firebaseAuth || !window.firebaseModules) {
          errorDiv.textContent = 'Firebase não está configurado. Configure as credenciais do Firebase no código.';
          errorDiv.classList.remove('hidden');
          return;
        }

        // Set persistence based on remember checkbox
        const { setPersistence, browserLocalPersistence, browserSessionPersistence } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const persistence = remember ? browserLocalPersistence : browserSessionPersistence;
        await setPersistence(window.firebaseAuth, persistence);

        errorDiv.textContent = 'Entrando...';
        errorDiv.classList.remove('hidden');
        errorDiv.classList.remove('bg-red-500/20', 'border-red-500/50', 'text-red-400');
        errorDiv.classList.add('bg-blue-500/20', 'border-blue-500/50', 'text-blue-400');

        await window.firebaseModules.signInWithEmailAndPassword(window.firebaseAuth, email, password);
        
        // Success - auth state will be updated by onAuthStateChanged
        closeLoginModal();
      } catch (error) {
        console.error('Erro no login:', error);
        errorDiv.classList.remove('bg-blue-500/20', 'border-blue-500/50', 'text-blue-400');
        errorDiv.classList.add('bg-red-500/20', 'border-red-500/50', 'text-red-400');
        
        let errorMessage = 'Erro ao fazer login.';
        if (error.code === 'auth/user-not-found') {
          errorMessage = 'Usuário não encontrado.';
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = 'Senha incorreta.';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'E-mail inválido.';
        } else if (error.code === 'auth/too-many-requests') {
          errorMessage = 'Muitas tentativas. Tente novamente mais tarde.';
        } else if (error.code === 'auth/invalid-credential') {
          errorMessage = 'Credenciais inválidas. Verifique seu e-mail e senha.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        errorDiv.textContent = errorMessage;
        errorDiv.classList.remove('hidden');
      }
    }

    async function handleLogout() {
      if (!confirm('Deseja fazer logout?')) return;
      
      try {
        if (window.firebaseAuth && window.firebaseModules) {
          await window.firebaseModules.signOut(window.firebaseAuth);
          // Auth state will be updated by onAuthStateChanged
        }
      } catch (error) {
        console.error('Erro ao fazer logout:', error);
        alert('Erro ao fazer logout. Tente novamente.');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Show loading screen
      setTimeout(async () => {
        // Wait for Firebase to be ready
        await new Promise((resolve) => {
          if (window.firebaseAuth && window.firebaseModules) {
            resolve();
          } else {
            window.addEventListener('firebase-ready', resolve, { once: true });
            // Timeout after 3 seconds
            setTimeout(resolve, 3000);
          }
        });
        
        // Check Firebase auth status and set up listener
        if (window.firebaseAuth && window.firebaseModules) {
          // Set up auth state listener
          window.firebaseModules.onAuthStateChanged(window.firebaseAuth, (user) => {
            isLoggedIn = !!user;
            updateUIForLoginStatus();
            renderAll();
          });
          
          // Check initial auth state
          await checkFirebaseAuth();
        }
        
        // Load data (tries Realtime Database first, falls back to localStorage)
        await loadFromRealtimeDatabase();
        
        // Set up real-time listeners for synchronization (non-blocking)
        setTimeout(() => {
          setupRealtimeListeners();
        }, 500);
        
        // Verify Realtime Database connection in background (non-blocking, for logging only)
        if (window.database && window.firebaseModules) {
          setTimeout(async () => {
            try {
              const { ref, get } = window.firebaseModules;
              const db = window.database;
              const testSnapshot = await get(ref(db, 'courses'));
              console.log('✅ Realtime Database funcionando corretamente', { exists: testSnapshot.exists() });
            } catch (error) {
              console.warn('⚠️ Realtime Database não acessível:', error.code || error.message);
              if (error.code === 'PERMISSION_DENIED') {
                console.warn('💡 Configure as regras do Realtime Database no Firebase Console.');
              }
            }
          }, 2000);
        }
        
        // Hide loading screen
        document.getElementById('loading-screen').classList.add('hidden');
        
        // Show app
        document.getElementById('app').classList.remove('hidden');
        
        // Update UI based on login status (initial state - not logged in by default)
        updateUIForLoginStatus();
        
        // Initialize filters and render
        updateFilters();
        renderAll();
      }, 800); // Simulate loading time
    });

    function switchTab(tab) {
      document.getElementById('tab-dashboard').classList.remove('active');
      document.getElementById('tab-settings').classList.remove('active');
      document.getElementById('content-dashboard').classList.add('hidden');
      document.getElementById('content-settings').classList.add('hidden');

      document.getElementById(`tab-${tab}`).classList.add('active');
      document.getElementById(`content-${tab}`).classList.remove('hidden');
    }

    function toggleMenuDrawer() {
      const drawer = document.getElementById('menu-drawer');
      const overlay = document.getElementById('menu-overlay');
      const isOpen = drawer.classList.contains('open');
      
      if (isOpen) {
        drawer.classList.remove('open');
        overlay.classList.remove('open');
      } else {
        drawer.classList.add('open');
        overlay.classList.add('open');
      }
    }

    function toggleFABMenu() {
      const menu = document.getElementById('fab-menu');
      const icon = document.getElementById('fab-icon');
      const closeIcon = document.getElementById('fab-close-icon');
      const isOpen = menu.classList.contains('open');
      
      if (isOpen) {
        menu.classList.remove('open');
        icon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
      } else {
        menu.classList.add('open');
        icon.classList.add('hidden');
        closeIcon.classList.remove('hidden');
      }
    }

    function renderAll() {
      renderStats();
      renderLotSections();
      updateUIForLoginStatus(); // Ensure UI reflects login status after render
    }

    function normalizeStatus(status) {
      if (!status) return '';
      return String(status).trim().toLowerCase();
    }

    function renderStats() {
      const total = filteredCourses.length;
      const completed = filteredCourses.filter(c => normalizeStatus(c.status) === 'concluído').length;
      const pending = filteredCourses.filter(c => normalizeStatus(c.status) === 'pendente').length;
      const inProgress = filteredCourses.filter(c => {
        const normalized = normalizeStatus(c.status);
        return normalized === 'em andamento' || normalized === 'em andamento.';
      }).length;
      
      // Debug: Log status variations found
      if (inProgress === 0 && total > 0) {
        const statusVariations = [...new Set(filteredCourses.map(c => c.status).filter(s => s))];
        const statusVariationsNormalized = [...new Set(filteredCourses.map(c => normalizeStatus(c.status)).filter(s => s))];
        // Only log if there are status values but no matches for "em andamento"
        if (statusVariationsNormalized.some(s => s.includes('andamento'))) {
          console.log('Status variations found:', statusVariations);
          console.log('Normalized status variations:', statusVariationsNormalized);
        }
      }

      document.getElementById('stats-cards').innerHTML = `
        <div class="card-elegant rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-muted-foreground">Total de Cursos</p>
              <p class="text-3xl font-bold text-foreground">${total}</p>
            </div>
            <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
            </div>
          </div>
        </div>
        <div class="card-elegant rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-muted-foreground">Concluídos</p>
              <p class="text-3xl font-bold text-green-500">${completed}</p>
            </div>
            <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center glow-border">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
          </div>
        </div>
        <div class="card-elegant rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-muted-foreground">Pendentes</p>
              <p class="text-3xl font-bold text-orange-500">${pending}</p>
            </div>
            <div class="w-12 h-12 bg-orange-500/20 rounded-xl flex items-center justify-center glow-border">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
        </div>
        <div class="card-elegant rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-muted-foreground">Em Andamento</p>
              <p class="text-3xl font-bold text-blue-500">${inProgress}</p>
            </div>
            <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
          </div>
        </div>
      `;
    }

    function renderLotSections() {
      const lots = [...new Set(filteredCourses.map(c => c.lote))].sort((a, b) => a - b);
      
      if (lots.length === 0) {
        document.getElementById('lot-sections').innerHTML = `
          <div class="text-center py-12 text-muted-foreground">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="text-lg">Nenhum curso cadastrado.</p>
            <p class="text-sm mt-2">Importe uma planilha ou adicione cursos manualmente.</p>
          </div>
        `;
        return;
      }

      document.getElementById('lot-sections').innerHTML = lots.map(lot => {
        const lotCourses = filteredCourses.filter(c => c.lote === lot);
        const responsibles = lotResponsibles[lot] || [];
        const pendingCount = lotCourses.filter(c => normalizeStatus(c.status) === 'pendente').length;
        
        return `
          <div class="card-elegant rounded-2xl overflow-hidden relative mb-6">
            <div class="p-5">
              <!-- Header do Card: Título, Responsáveis e Ações -->
              <div class="flex items-start justify-between gap-4 mb-4">
                <div class="flex-1 min-w-0">
                  <!-- Primeira Linha: Lote e Responsáveis -->
                  <div class="flex items-center gap-4 flex-wrap mb-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-primary/30 to-blue-600/30 rounded-xl flex items-center justify-center glow-border flex-shrink-0">
                      <span class="text-primary font-bold text-lg">${lot}</span>
                  </div>
                    <h2 class="text-xl font-semibold text-foreground">Lote ${lot}</h2>
              ${responsibles.length > 0 ? `
                      <div class="flex items-center gap-3 flex-wrap">
                  ${responsibles.map(r => `
                          <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0 border border-primary/30">
                        <span class="text-primary text-sm font-medium">${r.name.charAt(0)}</span>
                      </div>
                            <div class="flex flex-col">
                              <div class="flex items-center gap-2">
                                <p class="text-base font-medium text-foreground">${r.name}</p>
                      <a href="https://wa.me/${r.phone.replace(/\D/g, '')}" target="_blank" 
                                  class="w-8 h-8 bg-green-600/20 hover:bg-green-600/30 text-green-400 hover:text-green-300 rounded-lg flex items-center justify-center transition-all flex-shrink-0" title="Contatar via WhatsApp">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                        </svg>
                      </a>
                              </div>
                              <p class="text-xs text-muted-foreground">${r.cargo}</p>
                            </div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
                  
                  <!-- Segunda Linha: Quantidade de Cursos e Alertas -->
                  <div class="flex items-center gap-4 flex-wrap">
                    <p class="text-sm text-muted-foreground">${lotCourses.length} curso(s)</p>
                    ${pendingCount > 0 ? `
                      <div class="alert-pending" title="${pendingCount} curso(s) pendente(s)">
                        <span>Cursos Pendentes</span>
                        <span class="pending-count">${pendingCount}</span>
                      </div>
                    ` : ''}
                  </div>
                </div>
                
                <!-- Botões de Ação Minimalistas -->
                <div class="flex items-center gap-2 flex-shrink-0">
                  <button onclick="downloadLotPDF(${lot})" class="w-10 h-10 flex items-center justify-center bg-red-600/20 hover:bg-red-600/30 text-red-400 hover:text-red-300 rounded-xl transition-all duration-300 border border-red-600/30 hover:border-red-600/50" title="Baixar PDF do Lote">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  </button>
                  ${isLoggedIn ? `
                  <button onclick="openResponsiblesModal(${lot})" class="w-10 h-10 flex items-center justify-center border border-border/50 hover:bg-secondary/50 text-foreground hover:text-primary rounded-xl transition-all duration-300 relative" title="Gerenciar Responsáveis">
                    ${responsibles.length > 0 ? `<span class="absolute -top-1 -right-1 w-5 h-5 bg-primary text-white text-xs rounded-full flex items-center justify-center">${responsibles.length}</span>` : ''}
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                  </button>
                  ` : ''}
                </div>
              </div>
            </div>
            
            <div class="border-t border-border/30"></div>
            
            <!-- Desktop Table -->
            <div class="hidden md:block overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-secondary/50">
                  <tr>
                    <!-- Added ID column to table header -->
                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">ID</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Tipologia</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Carga Horária</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Início</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Fim</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Município</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Cozinha</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Concludentes</th>
                    ${isLoggedIn ? '<th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Ações</th>' : ''}
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  ${lotCourses.map(course => `
                    <tr class="hover:bg-secondary/30 transition-colors cursor-pointer" onclick="openEditCourseModal('${course.id}')">
                      <!-- Added ID column to table row -->
                      <td class="px-4 py-3 text-muted-foreground font-mono text-xs">${course.idCurso || '-'}</td>
                      <td class="px-4 py-3 text-foreground font-medium">${course.tipologia}</td>
                      <td class="px-4 py-3 text-muted-foreground">${course.cargaHoraria}h</td>
                      <td class="px-4 py-3 text-muted-foreground">${course.dataInicio ? formatDate(course.dataInicio) : '-'}</td>
                      <td class="px-4 py-3 text-muted-foreground">${course.dataFim ? formatDate(course.dataFim) : '-'}</td>
                      <td class="px-4 py-3 text-muted-foreground">${course.municipio}</td>
                      <td class="px-4 py-3 text-muted-foreground">${course.cozinha || '-'}</td>
                      <td class="px-4 py-3">${getStatusBadge(course.status)}</td>
                      <td class="px-4 py-3 text-muted-foreground">${course.concludentes !== null ? course.concludentes : '-'}</td>
                      ${isLoggedIn ? `
                      <td class="px-4 py-3">
                        <button onclick="event.stopPropagation(); deleteCourse('${course.id}')" class="p-2 text-red-400 hover:bg-red-500/20 rounded-lg transition-colors" title="Excluir curso">
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      </td>
                      ` : ''}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>

            <!-- Mobile Cards -->
            <div class="md:hidden p-4 space-y-3">
              ${lotCourses.map(course => `
                <div class="bg-secondary/30 border border-border rounded-lg p-4 space-y-3 cursor-pointer hover:bg-secondary/40 transition-colors" onclick="openEditCourseModal('${course.id}')">
                  <div class="flex items-start justify-between">
                    <div>
                      <h3 class="font-medium text-foreground">${course.tipologia}</h3>
                      <!-- Added ID display in mobile card -->
                      <p class="text-xs text-muted-foreground font-mono">ID: ${course.idCurso || '-'}</p>
                    </div>
                    <div class="flex items-center gap-2">
                      ${getStatusBadge(course.status)}
                      ${isLoggedIn ? `
                      <button onclick="event.stopPropagation(); deleteCourse('${course.id}')" class="p-1 text-red-400 hover:bg-red-500/20 rounded transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                      ` : ''}
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>
                      <p class="text-muted-foreground">Carga Horária</p>
                      <p class="text-foreground">${course.cargaHoraria}h</p>
                    </div>
                    <div>
                      <p class="text-muted-foreground">Município</p>
                      <p class="text-foreground">${course.municipio}</p>
                    </div>
                    <div>
                      <p class="text-muted-foreground">Cozinha</p>
                      <p class="text-foreground">${course.cozinha || '-'}</p>
                    </div>
                    <div>
                      <p class="text-muted-foreground">Início</p>
                      <p class="text-foreground">${course.dataInicio ? formatDate(course.dataInicio) : '-'}</p>
                    </div>
                    <div>
                      <p class="text-muted-foreground">Fim</p>
                      <p class="text-foreground">${course.dataFim ? formatDate(course.dataFim) : '-'}</p>
                    </div>
                    <div>
                      <p class="text-muted-foreground">Concludentes</p>
                      <p class="text-foreground">${course.concludentes !== null ? course.concludentes : '-'}</p>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function getStatusBadge(status) {
      if (!status) status = 'Pendente';
      const normalized = normalizeStatus(status);
      const statusMap = {
        'concluído': { label: 'Concluído', style: 'bg-green-500/20 text-green-400 border-green-500/30' },
        'pendente': { label: 'Pendente', style: 'bg-orange-500/20 text-orange-400 border-orange-500/30' },
        'em andamento': { label: 'Em andamento', style: 'bg-blue-500/20 text-blue-400 border-blue-500/30' },
        'em andamento.': { label: 'Em andamento', style: 'bg-blue-500/20 text-blue-400 border-blue-500/30' }
      };
      
      const statusInfo = statusMap[normalized] || { label: String(status).trim() || 'Pendente', style: 'bg-gray-500/20 text-gray-400 border-gray-500/30' };
      return `<span class="inline-flex px-2 py-1 text-xs font-medium rounded-full border ${statusInfo.style}">${statusInfo.label}</span>`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('pt-BR');
    }

    function updateFilters() {
      const lots = [...new Set(courses.map(c => c.lote))].sort((a, b) => a - b);
      const municipios = [...new Set(courses.map(c => c.municipio))].filter(m => m).sort();

      const loteSelect = document.getElementById('filter-lote');
      loteSelect.innerHTML = '<option value="">Todos os Lotes</option>' + 
        lots.map(l => `<option value="${l}">Lote ${l}</option>`).join('');

      const municipioSelect = document.getElementById('filter-municipio');
      municipioSelect.innerHTML = '<option value="">Todos os Municípios</option>' + 
        municipios.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    function applyFilters() {
      const search = document.getElementById('filter-search').value.toLowerCase();
      const lote = document.getElementById('filter-lote').value;
      const municipio = document.getElementById('filter-municipio').value;
      const status = document.getElementById('filter-status').value;

      filteredCourses = courses.filter(course => {
        if (lote && String(course.lote) !== lote) return false;
        if (municipio && course.municipio !== municipio) return false;
        if (status && course.status !== status) return false;
        if (search && !course.tipologia.toLowerCase().includes(search)) return false;
        return true;
      });

      renderAll();
    }

    function deleteCourse(id) {
      if (!isLoggedIn) {
        openLoginModal();
        return;
      }
      if (!confirm('Deseja excluir este curso?')) return;
      courses = courses.filter(c => c.id !== id);
      filteredCourses = filteredCourses.filter(c => c.id !== id);
      saveToStorage(); // Save after deletion
      updateFilters();
      renderAll();
    }

    function openEditCourseModal(courseId) {
      const course = courses.find(c => c.id === courseId);
      if (!course) return;
      
      currentEditCourse = course;
      
      // Preencher informações somente leitura
      document.getElementById('edit-course-id').textContent = course.idCurso || '-';
      document.getElementById('edit-course-tipologia').textContent = course.tipologia || '-';
      document.getElementById('edit-course-carga').textContent = course.cargaHoraria ? `${course.cargaHoraria}h` : '-';
      document.getElementById('edit-course-lote').textContent = course.lote || '-';
      document.getElementById('edit-course-municipio').textContent = course.municipio || '-';
      document.getElementById('edit-course-cozinha').textContent = course.cozinha || '-';
      
      // Preencher campos editáveis
      document.getElementById('edit-course-inicio').value = course.dataInicio ? course.dataInicio : '';
      document.getElementById('edit-course-fim').value = course.dataFim ? course.dataFim : '';
      document.getElementById('edit-course-status').value = course.status || 'Pendente';
      document.getElementById('edit-course-concludentes').value = course.concludentes !== null ? course.concludentes : '';
      
      // Mostrar/ocultar seção de edição baseado no login
      const editableSection = document.getElementById('edit-course-editable-section');
      const actionsSection = document.getElementById('edit-course-actions');
      const viewOnlySection = document.getElementById('edit-course-view-only');
      
      if (isLoggedIn) {
        editableSection.classList.remove('hidden');
        actionsSection.classList.remove('hidden');
        viewOnlySection.classList.add('hidden');
      } else {
        editableSection.classList.add('hidden');
        actionsSection.classList.add('hidden');
        viewOnlySection.classList.remove('hidden');
      }
      
      // Mostrar modal e aplicar efeito no header
      document.getElementById('edit-course-modal').classList.remove('hidden');
      document.body.classList.add('modal-open');
    }

    function closeEditCourseModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('edit-course-modal').classList.add('hidden');
      document.body.classList.remove('modal-open');
      currentEditCourse = null;
    }

    function saveEditedCourse() {
      if (!currentEditCourse) return;
      
      const dataInicio = document.getElementById('edit-course-inicio').value || null;
      const dataFim = document.getElementById('edit-course-fim').value || null;
      const status = document.getElementById('edit-course-status').value;
      const concludentes = document.getElementById('edit-course-concludentes').value ? parseInt(document.getElementById('edit-course-concludentes').value) : null;
      
      // Atualizar curso
      const courseIndex = courses.findIndex(c => c.id === currentEditCourse.id);
      if (courseIndex !== -1) {
        courses[courseIndex].dataInicio = dataInicio;
        courses[courseIndex].dataFim = dataFim;
        courses[courseIndex].status = status;
        courses[courseIndex].concludentes = concludentes;
        
        // Atualizar também no filteredCourses
        const filteredIndex = filteredCourses.findIndex(c => c.id === currentEditCourse.id);
        if (filteredIndex !== -1) {
          filteredCourses[filteredIndex].dataInicio = dataInicio;
          filteredCourses[filteredIndex].dataFim = dataFim;
          filteredCourses[filteredIndex].status = status;
          filteredCourses[filteredIndex].concludentes = concludentes;
        }
      }
      
      // Salvar e atualizar
      saveToStorage();
      renderAll();
      closeEditCourseModal();
      alert('Curso atualizado com sucesso!');
    }

    function deleteLot() {
      if (!confirm(`Deseja excluir o Lote ${currentEditLot} inteiro? Todos os cursos e responsáveis serão removidos.`)) return;
      courses = courses.filter(c => c.lote !== currentEditLot);
      filteredCourses = filteredCourses.filter(c => c.lote !== currentEditLot);
      delete lotResponsibles[currentEditLot];
      saveToStorage(); // Save after deletion
      closeResponsiblesModal();
      updateFilters();
      renderAll();
    }

    function deleteAllCourses() {
      if (!confirm('Deseja excluir TODOS os cursos? Esta ação não pode ser desfeita.')) return;
      courses = [];
      filteredCourses = [];
      saveToStorage(); // Save after deletion
      updateFilters();
      renderAll();
      alert('Todos os cursos foram excluídos.');
    }

    function deleteAllResponsibles() {
      if (!confirm('Deseja excluir TODOS os responsáveis de todos os lotes? Esta ação não pode ser desfeita.')) return;
      lotResponsibles = {};
      saveToStorage(); // Save after deletion
      renderAll();
      alert('Todos os responsáveis foram excluídos.');
    }

    function deleteAllData() {
      if (!confirm('ATENÇÃO: Deseja excluir TODOS os dados (cursos e responsáveis)? Esta ação não pode ser desfeita.')) return;
      if (!confirm('Tem certeza absoluta? Esta ação é IRREVERSÍVEL.')) return;
      courses = [];
      filteredCourses = [];
      lotResponsibles = {};
      saveToStorage(); // Save after deletion
      updateFilters();
      renderAll();
      alert('Todos os dados foram excluídos.');
    }

    // Backup and Restore Functions
    function exportBackup() {
      try {
        const backup = {
          version: '1.0',
          exportDate: new Date().toISOString(),
          data: {
            courses: courses,
            responsibles: lotResponsibles
          }
        };

        const dataStr = JSON.stringify(backup, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        const dateStr = new Date().toISOString().split('T')[0];
        link.download = `backup-cursos-${dateStr}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        alert(`Backup exportado com sucesso!\n${courses.length} curso(s) e ${Object.keys(lotResponsibles).length} lote(s) com responsáveis.`);
      } catch (error) {
        console.error('Erro ao exportar backup:', error);
        alert('Erro ao exportar backup. Verifique o console para mais detalhes.');
      }
    }

    let backupPreviewData = null;

    function openRestoreModal() {
      if (!isLoggedIn) {
        openLoginModal();
        return;
      }
      document.getElementById('restore-modal').classList.remove('hidden');
      document.body.classList.add('modal-open');
      document.getElementById('restore-file-input').value = '';
      document.getElementById('restore-error').classList.add('hidden');
      document.getElementById('restore-preview').classList.add('hidden');
      backupPreviewData = null;
    }

    function closeRestoreModal() {
      document.getElementById('restore-modal').classList.add('hidden');
      document.body.classList.remove('modal-open');
      document.getElementById('restore-file-input').value = '';
      document.getElementById('restore-error').classList.add('hidden');
      document.getElementById('restore-preview').classList.add('hidden');
      backupPreviewData = null;
    }

    // Auto-preview when file is selected
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('restore-file-input');
      if (fileInput) {
        fileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              try {
                const backup = JSON.parse(e.target.result);
                backupPreviewData = backup;
                
                // Validate backup structure
                if (!backup.data || (!backup.data.courses && !backup.data.responsibles)) {
                  throw new Error('Formato de backup inválido. O arquivo deve conter dados de cursos e/ou responsáveis.');
                }
                
                const coursesCount = backup.data.courses ? backup.data.courses.length : 0;
                const responsiblesCount = backup.data.responsibles ? Object.keys(backup.data.responsibles).length : 0;
                
                const previewContent = `
                  <div class="space-y-2">
                    <p><span class="font-medium">Data do backup:</span> ${backup.exportDate ? new Date(backup.exportDate).toLocaleString('pt-BR') : 'Desconhecida'}</p>
                    <p><span class="font-medium">Cursos:</span> ${coursesCount}</p>
                    <p><span class="font-medium">Lotes com responsáveis:</span> ${responsiblesCount}</p>
                    <p class="text-xs text-muted-foreground mt-3">Selecione o modo de restauração acima e clique em "Restaurar" para continuar.</p>
                  </div>
                `;
                
                document.getElementById('restore-preview-content').innerHTML = previewContent;
                document.getElementById('restore-preview').classList.remove('hidden');
                document.getElementById('restore-error').classList.add('hidden');
              } catch (error) {
                console.error('Erro ao ler backup:', error);
                document.getElementById('restore-error').textContent = `Erro ao ler arquivo: ${error.message}`;
                document.getElementById('restore-error').classList.remove('hidden');
                document.getElementById('restore-preview').classList.add('hidden');
                backupPreviewData = null;
              }
            };
            reader.readAsText(file);
          }
        });
      }
    });

    async function confirmRestore() {
      if (!backupPreviewData) {
        document.getElementById('restore-error').textContent = 'Por favor, selecione um arquivo de backup válido.';
        document.getElementById('restore-error').classList.remove('hidden');
        return;
      }

      const restoreMode = document.querySelector('input[name="restore-mode"]:checked').value;
      
      if (restoreMode === 'replace') {
        if (!confirm('⚠️ ATENÇÃO: Isso irá substituir TODOS os dados atuais pelos dados do backup. Esta ação não pode ser desfeita. Deseja continuar?')) {
          return;
        }
        if (!confirm('Tem certeza absoluta? Todos os cursos e responsáveis atuais serão perdidos!')) {
          return;
        }
      } else {
        if (!confirm(`Isso irá adicionar os dados do backup aos dados existentes.\n${backupPreviewData.data.courses ? backupPreviewData.data.courses.length : 0} curso(s) e ${backupPreviewData.data.responsibles ? Object.keys(backupPreviewData.data.responsibles).length : 0} lote(s) com responsáveis serão adicionados.\nDeseja continuar?`)) {
          return;
        }
      }

      try {
        if (restoreMode === 'replace') {
          // Replace all data
          courses = backupPreviewData.data.courses || [];
          lotResponsibles = backupPreviewData.data.responsibles || {};
        } else {
          // Merge data
          const existingCourseIds = new Set(courses.map(c => c.id));
          const newCourses = (backupPreviewData.data.courses || []).filter(c => !existingCourseIds.has(c.id));
          courses = [...courses, ...newCourses];
          
          // Merge responsibles
          if (backupPreviewData.data.responsibles) {
            Object.keys(backupPreviewData.data.responsibles).forEach(lot => {
              if (!lotResponsibles[lot]) {
                lotResponsibles[lot] = [];
              }
              const existingRespIds = new Set((lotResponsibles[lot] || []).map(r => r.id));
              const newResponsibles = (backupPreviewData.data.responsibles[lot] || []).filter(r => !existingRespIds.has(r.id));
              lotResponsibles[lot] = [...(lotResponsibles[lot] || []), ...newResponsibles];
            });
          }
        }

        filteredCourses = [...courses];
        await saveToStorage();
        updateFilters();
        renderAll();
        closeRestoreModal();
        
        const restoredCourses = restoreMode === 'replace' ? courses.length : (backupPreviewData.data.courses || []).length;
        const restoredResponsibles = restoreMode === 'replace' 
          ? Object.keys(lotResponsibles).length 
          : Object.keys(backupPreviewData.data.responsibles || {}).length;
        
        alert(`Backup restaurado com sucesso!\n${restoredCourses} curso(s) e ${restoredResponsibles} lote(s) com responsáveis.`);
      } catch (error) {
        console.error('Erro ao restaurar backup:', error);
        document.getElementById('restore-error').textContent = `Erro ao restaurar backup: ${error.message}`;
        document.getElementById('restore-error').classList.remove('hidden');
      }
    }

    function openAddCourseModal() {
      if (!isLoggedIn) {
        openLoginModal();
        return;
      }
      // Fechar FAB menu se estiver aberto
      const fabMenu = document.getElementById('fab-menu');
      if (fabMenu && fabMenu.classList.contains('open')) {
        toggleFABMenu();
      }
      document.getElementById('add-course-modal').classList.remove('hidden');
      document.body.classList.add('modal-open');
    }

    function closeAddCourseModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('add-course-modal').classList.add('hidden');
      document.body.classList.remove('modal-open');
      document.getElementById('course-id').value = ''; // Clear ID field
      document.getElementById('course-tipologia').value = '';
      document.getElementById('course-carga').value = '';
      document.getElementById('course-lote').value = '';
      document.getElementById('course-inicio').value = '';
      document.getElementById('course-fim').value = '';
      document.getElementById('course-municipio').value = '';
      document.getElementById('course-cozinha').value = '';
      document.getElementById('course-status').value = 'Pendente';
      document.getElementById('course-concludentes').value = '';
    }

    function saveCourse() {
      if (!isLoggedIn) {
        openLoginModal();
        return;
      }
      const idCurso = document.getElementById('course-id').value.trim(); // Get ID
      const tipologia = document.getElementById('course-tipologia').value.trim();
      const cargaHoraria = parseInt(document.getElementById('course-carga').value);
      const lote = parseInt(document.getElementById('course-lote').value);
      const municipio = document.getElementById('course-municipio').value.trim();
      const dataInicio = document.getElementById('course-inicio').value || null;
      const dataFim = document.getElementById('course-fim').value || null;
      const status = document.getElementById('course-status').value;
      const concludentes = document.getElementById('course-concludentes').value ? parseInt(document.getElementById('course-concludentes').value) : null;
      const cozinha = document.getElementById('course-cozinha').value.trim() || null;

      if (!tipologia || !cargaHoraria || !lote || !municipio) {
        alert('Preencha todos os campos obrigatórios (*)');
        return;
      }

      const newCourse = {
        id: `course-${Date.now()}`,
        idCurso: idCurso || null, // Include course ID
        tipologia,
        cargaHoraria,
        lote,
        municipio,
        cozinha,
        dataInicio,
        dataFim,
        status,
        concludentes
      };

      courses.push(newCourse);
      filteredCourses = [...courses];
      saveToStorage(); // Save after adding
      updateFilters();
      applyFilters();
      closeAddCourseModal();
      alert('Curso adicionado com sucesso!');
    }

    // Import Modal Functions
    function openImportModal() {
      if (!isLoggedIn) {
        openLoginModal();
        return;
      }
      // Fechar FAB menu se estiver aberto
      const fabMenu = document.getElementById('fab-menu');
      if (fabMenu && fabMenu.classList.contains('open')) {
        toggleFABMenu();
      }
      document.getElementById('import-modal').classList.remove('hidden');
      document.body.classList.add('modal-open');
      resetImportModal();
    }

    function closeImportModal() {
      document.getElementById('import-modal').classList.add('hidden');
      document.body.classList.remove('modal-open');
      resetImportModal();
    }

    function resetImportModal() {
      document.getElementById('import-step-1').classList.remove('hidden');
      document.getElementById('import-step-2').classList.add('hidden');
      document.getElementById('import-step-3').classList.add('hidden');
      document.getElementById('file-input').value = '';
      uploadedData = [];
      fileColumns = [];
      columnMapping = {};
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        if (jsonData.length < 2) {
          alert('A planilha precisa ter pelo menos um cabeçalho e uma linha de dados.');
          return;
        }

        fileColumns = jsonData[0].map(col => String(col || '').trim()).filter(col => col);
        uploadedData = jsonData.slice(1).filter(row => row.some(cell => cell !== null && cell !== '' && cell !== undefined));

        // Enhanced auto-detect column mapping - Map all possible fields intelligently
        const fieldNames = Object.keys(fieldLabels);
        const mappingPatterns = {
          idCurso: ['id', 'código', 'codigo', 'identificador', 'num', 'número', 'numero'],
          tipologia: ['tipologia', 'tipo', 'curso', 'nome', 'nome do curso', 'curso/tipologia', 'descrição', 'descricao'],
          cargaHoraria: ['carga', 'horária', 'horaria', 'carga horária', 'carga horaria', 'horas', 'h', 'ch', 'carga hor'],
          dataInicio: ['início', 'inicio', 'data início', 'data inicio', 'dt início', 'dt inicio', 'início previsto', 'inicio previsto', 'start', 'começo', 'comeco'],
          dataFim: ['fim', 'término', 'termino', 'data fim', 'data término', 'dt fim', 'dt termino', 'conclusão', 'conclusao', 'end', 'final'],
          municipio: ['município', 'municipio', 'cidade', 'local', 'localização', 'localizacao', 'município sede', 'municipio sede'],
          lote: ['lote', 'grupo', 'batch', 'lote número', 'lote numero', 'lote nº'],
          status: ['status', 'situação', 'situacao', 'estado', 'andamento', 'status do curso'],
          concludentes: ['concludentes', 'concluintes', 'alunos', 'matriculados', 'quantidade', 'qtd', 'total'],
          cozinha: ['cozinha', 'coz', 'kitchen', 'nome cozinha', 'cozinha do curso']
        };

        // Enhanced mapping with multiple patterns
        fieldNames.forEach(field => {
          const patterns = mappingPatterns[field] || [];
          const labelLower = fieldLabels[field].toLowerCase();
          
          const matchingCol = fileColumns.find(col => {
            const colLower = col.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            // Check exact match or field name
            if (colLower === field.toLowerCase() || colLower === labelLower) return true;
            
            // Check if column contains any of the patterns
            if (patterns.some(pattern => colLower.includes(pattern))) return true;
            
            // Check if label contains column name
            if (labelLower.includes(colLower) || colLower.includes(labelLower)) return true;
            
            // Special cases
            if (field === 'idCurso' && (colLower.match(/^(id|cód|cod|num)/) || colLower.includes('identificador'))) return true;
            if (field === 'cargaHoraria' && (colLower.includes('hor') || colLower.includes('carga'))) return true;
            if (field === 'municipio' && (colLower.includes('munic') || colLower.includes('cidade'))) return true;
            
            return false;
          });
          
          if (matchingCol) {
            columnMapping[field] = matchingCol;
          }
        });

        // Store additional columns that weren't mapped to standard fields
        const mappedColumns = Object.values(columnMapping).filter(v => v);
        columnMapping._additionalColumns = fileColumns.filter(col => !mappedColumns.includes(col));

        renderMappingStep();
        document.getElementById('import-step-1').classList.add('hidden');
        document.getElementById('import-step-2').classList.remove('hidden');
      };
      reader.readAsArrayBuffer(file);
    }

    function renderMappingStep() {
      const fields = Object.keys(fieldLabels);
      const additionalCols = columnMapping._additionalColumns || [];
      
      let html = fields.map(field => `
        <div class="flex items-center gap-4">
          <label class="w-32 text-sm font-medium text-foreground">${fieldLabels[field]} ${field === 'lote' ? '*' : ''}</label>
          <select id="map-${field}" class="flex-1 px-3 py-2 bg-input border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary">
            <option value="">-- Não mapear --</option>
            ${fileColumns.map(col => `<option value="${col}" ${columnMapping[field] === col ? 'selected' : ''}>${col}</option>`).join('')}
          </select>
        </div>
      `).join('');
      
      // Add additional columns mapping section
      if (additionalCols.length > 0) {
        html += `
          <div class="mt-6 pt-4 border-t border-border">
            <h4 class="text-sm font-medium text-foreground mb-3">Colunas Adicionais Encontradas</h4>
            <p class="text-xs text-muted-foreground mb-4">Estas colunas foram encontradas na planilha e podem ser adicionadas como informações extras:</p>
            <div id="additional-mapping" class="space-y-3">
              ${additionalCols.map((col, idx) => `
                <div class="flex items-center gap-4">
                  <label class="w-32 text-sm text-muted-foreground truncate" title="${col}">${col.length > 20 ? col.substring(0, 20) + '...' : col}</label>
                  <div class="flex-1 flex items-center gap-2">
                    <input type="checkbox" id="add-col-${idx}" checked class="w-4 h-4 text-primary bg-input border-border rounded focus:ring-primary">
                    <label for="add-col-${idx}" class="text-sm text-muted-foreground">Incluir como informação adicional</label>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      document.getElementById('mapping-fields').innerHTML = html;
    }

    function backToStep1() {
      document.getElementById('import-step-1').classList.remove('hidden');
      document.getElementById('import-step-2').classList.add('hidden');
    }

    function backToStep2() {
      document.getElementById('import-step-2').classList.remove('hidden');
      document.getElementById('import-step-3').classList.add('hidden');
    }

    function goToStep3() {
      // Collect mapping
      const fields = Object.keys(fieldLabels);
      fields.forEach(field => {
        const select = document.getElementById(`map-${field}`);
        columnMapping[field] = select.value;
      });

      renderPreview();
      document.getElementById('import-step-2').classList.add('hidden');
      document.getElementById('import-step-3').classList.remove('hidden');
    }

    function renderPreview() {
      const previewData = uploadedData.slice(0, 5);
      const fields = Object.keys(fieldLabels);

      let tableHtml = `
        <thead class="bg-secondary/50">
          <tr>
            ${fields.map(f => `<th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground uppercase whitespace-nowrap">${fieldLabels[f]}</th>`).join('')}
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
      `;

      previewData.forEach(row => {
        tableHtml += '<tr>';
        fields.forEach(field => {
          const colName = columnMapping[field];
          const colIndex = colName ? fileColumns.indexOf(colName) : -1;
          const value = colIndex >= 0 ? (row[colIndex] ?? '-') : '-';
          tableHtml += `<td class="px-3 py-2 text-foreground text-sm whitespace-nowrap">${value}</td>`;
        });
        tableHtml += '</tr>';
      });

      tableHtml += '</tbody>';
      document.getElementById('preview-table').innerHTML = tableHtml;
    }

    function confirmImport() {
      if (!isLoggedIn) {
        openLoginModal();
        closeImportModal();
        return;
      }
        const fields = Object.keys(fieldLabels);
        
        const loteColumn = columnMapping['lote'];
        if (!loteColumn) {
          alert('Por favor, mapeie a coluna "Lote" para que os cursos sejam separados corretamente.');
          backToStep2();
          return;
        }
        
        // Get additional columns to include
        const additionalCols = columnMapping._additionalColumns || [];
        const additionalColsToInclude = [];
        additionalCols.forEach((col, idx) => {
          const checkbox = document.getElementById(`add-col-${idx}`);
          if (checkbox && checkbox.checked) {
            additionalColsToInclude.push(col);
          }
        });
        
        const newCourses = uploadedData.map((row, index) => {
          const course = { id: `imported-${Date.now()}-${index}`, additionalInfo: {} };
          
          fields.forEach(field => {
            const colName = columnMapping[field];
            const colIndex = colName ? fileColumns.indexOf(colName) : -1;
            let value = colIndex >= 0 ? row[colIndex] : null;

          if (field === 'idCurso') {
            value = value !== null && value !== '' && value !== undefined ? String(value).trim() : null;
          } else if (field === 'cargaHoraria' || field === 'concludentes') {
            value = value !== null && value !== '' && value !== undefined ? Number(value) : (field === 'concludentes' ? null : 0);
          } else if (field === 'lote') {
            const parsed = parseInt(value, 10);
            value = !isNaN(parsed) && parsed > 0 ? parsed : null;
          } else if (field === 'status') {
            if (value) {
              const normalized = String(value).trim().toLowerCase();
              // Normalize to standard values
              if (normalized === 'concluído' || normalized === 'concluido') {
                value = 'Concluído';
              } else if (normalized === 'pendente') {
                value = 'Pendente';
              } else if (normalized === 'em andamento' || normalized === 'em andamento.' || normalized === 'andamento') {
                value = 'Em andamento';
              } else {
                value = String(value).trim();
              }
            } else {
              value = 'Pendente';
            }
          } else if (field === 'cozinha') {
            value = value !== null && value !== '' && value !== undefined ? String(value).trim() : null;
          } else if (field === 'dataInicio' || field === 'dataFim') {
            if (value && typeof value === 'number') {
              // Excel date serial number
              const date = new Date((value - 25569) * 86400 * 1000);
              value = date.toISOString().split('T')[0];
            } else if (value && typeof value === 'string') {
              // Try to parse date string
              const parsed = new Date(value);
              value = !isNaN(parsed.getTime()) ? parsed.toISOString().split('T')[0] : null;
            } else {
              value = null;
            }
          } else {
            value = value !== null && value !== undefined ? String(value).trim() : '';
          }

            course[field] = value;
          });
          
          // Add additional columns as extra info
          additionalColsToInclude.forEach(col => {
            const colIndex = fileColumns.indexOf(col);
            if (colIndex >= 0 && row[colIndex] !== null && row[colIndex] !== undefined && row[colIndex] !== '') {
              course.additionalInfo[col] = String(row[colIndex]).trim();
            }
          });

          return course;
        });

      const validCourses = newCourses.filter(c => c.lote !== null && c.lote > 0);
      const invalidCount = newCourses.length - validCourses.length;
      
      if (validCourses.length === 0) {
        alert('Nenhum curso possui um número de lote válido. Verifique se a coluna "Lote" está mapeada corretamente e contém números válidos.');
        return;
      }

      courses = [...courses, ...validCourses];
      filteredCourses = [...courses];
      saveToStorage();
      updateFilters();
      renderAll();
      closeImportModal();
      
      let message = `${validCourses.length} cursos importados com sucesso!`;
      if (invalidCount > 0) {
        message += `\n\n${invalidCount} curso(s) foram ignorados por não terem um lote válido.`;
      }
      alert(message);
    }

    // Responsibles Modal Functions
    function openResponsiblesModal(lotNumber) {
      if (!isLoggedIn) {
        openLoginModal();
        return;
      }
      currentEditLot = lotNumber;
      document.getElementById('modal-lot-name').textContent = `Lote ${lotNumber}`;
      document.getElementById('responsibles-modal').classList.remove('hidden');
      document.body.classList.add('modal-open');
      renderLotCourseInfo(lotNumber);
      renderResponsiblesList();
      updateUIForLoginStatus(); // Update modal UI
    }
    
    function renderLotCourseInfo(lotNumber) {
      const lotCourses = courses.filter(c => c.lote === lotNumber);
      const infoContent = document.getElementById('lot-course-info-content');
      
      if (lotCourses.length === 0) {
        infoContent.innerHTML = '<p class="text-xs text-muted-foreground">Nenhum curso encontrado neste lote.</p>';
        return;
      }
      
      // Get all unique additional info keys from all courses in the lot
      const allAdditionalInfo = {};
      lotCourses.forEach(course => {
        if (course.additionalInfo && Object.keys(course.additionalInfo).length > 0) {
          Object.assign(allAdditionalInfo, course.additionalInfo);
        }
      });
      
      let html = '';
      
      // Show basic course info
      html += `<div class="grid grid-cols-2 gap-2 mb-3">`;
      html += `<div><span class="font-medium">Total de Cursos:</span> ${lotCourses.length}</div>`;
      html += `<div><span class="font-medium">Tipologias:</span> ${[...new Set(lotCourses.map(c => c.tipologia))].length}</div>`;
      html += `</div>`;
      
      // Show additional info if available
      if (Object.keys(allAdditionalInfo).length > 0) {
        html += `<div class="mt-3 pt-3 border-t border-border">`;
        html += `<p class="text-xs font-medium text-foreground mb-2">Informações Adicionais:</p>`;
        html += `<div class="space-y-1">`;
        Object.keys(allAdditionalInfo).forEach(key => {
          const values = lotCourses
            .map(c => c.additionalInfo && c.additionalInfo[key])
            .filter(v => v)
            .filter((v, i, arr) => arr.indexOf(v) === i); // Unique values
          
          if (values.length > 0) {
            html += `<div><span class="text-xs font-medium">${key}:</span> <span class="text-xs">${values.join(', ')}</span></div>`;
          }
        });
        html += `</div></div>`;
      }
      
      infoContent.innerHTML = html || '<p class="text-xs text-muted-foreground">Nenhuma informação adicional disponível.</p>';
    }

    function closeResponsiblesModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('responsibles-modal').classList.add('hidden');
      document.body.classList.remove('modal-open');
      document.getElementById('resp-name').value = '';
      document.getElementById('resp-cargo').value = '';
      document.getElementById('resp-phone').value = '';
      currentEditLot = null;
    }

    function renderResponsiblesList() {
      const responsibles = lotResponsibles[currentEditLot] || [];
      
      if (responsibles.length === 0) {
        document.getElementById('responsibles-list').innerHTML = `
          <p class="text-center text-muted-foreground py-4">Nenhum responsável cadastrado.</p>
        `;
        return;
      }

      document.getElementById('responsibles-list').innerHTML = responsibles.map(r => `
        <div class="bg-secondary/30 border border-border rounded-lg p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center">
                <span class="text-primary font-medium">${r.name.charAt(0)}</span>
              </div>
              <div>
                <p class="font-medium text-foreground">${r.name}</p>
                <p class="text-sm text-muted-foreground">${r.cargo}</p>
                <p class="text-xs text-muted-foreground">${r.phone}</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <a href="https://wa.me/${r.phone.replace(/\D/g, '')}" target="_blank" 
                class="w-10 h-10 bg-green-600 hover:bg-green-700 rounded-lg flex items-center justify-center transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
              </a>
              ${isLoggedIn ? `
              <button onclick="removeResponsible('${r.id}')" class="w-10 h-10 bg-red-600/20 hover:bg-red-600/40 rounded-lg flex items-center justify-center transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function addResponsible() {
      if (!isLoggedIn) {
        openLoginModal();
        return;
      }
      const name = document.getElementById('resp-name').value.trim();
      const cargo = document.getElementById('resp-cargo').value.trim();
      const phone = document.getElementById('resp-phone').value.trim();

      if (!name || !cargo || !phone) {
        alert('Preencha todos os campos.');
        return;
      }

      if (!lotResponsibles[currentEditLot]) {
        lotResponsibles[currentEditLot] = [];
      }

      lotResponsibles[currentEditLot].push({
        id: `resp-${Date.now()}`,
        name,
        cargo,
        phone
      });

      document.getElementById('resp-name').value = '';
      document.getElementById('resp-cargo').value = '';
      document.getElementById('resp-phone').value = '';

      saveToStorage(); // Save after adding responsible
      renderResponsiblesList();
      renderLotSections();
    }

    function removeResponsible(id) {
      if (!isLoggedIn) {
        openLoginModal();
        return;
      }
      if (!confirm('Deseja remover este responsável?')) return;
      
      lotResponsibles[currentEditLot] = lotResponsibles[currentEditLot].filter(r => r.id !== id);
      saveToStorage(); // Save after removing responsible
      renderResponsiblesList();
      renderLotSections();
    }

    function downloadLotPDF(lotNumber) {
      const { jsPDF } = window.jspdf;
      const lotCourses = courses.filter(c => c.lote === lotNumber);
      const responsibles = lotResponsibles[lotNumber] || [];
      
      if (lotCourses.length === 0) {
        alert('Nenhum curso encontrado neste lote.');
        return;
      }
      
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 20;
      let yPos = margin;
      
      // Título
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text(`Lote ${lotNumber}`, pageWidth / 2, yPos, { align: 'center' });
      yPos += 15;
      
      // Informações gerais
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      doc.text(`Total de Cursos: ${lotCourses.length}`, margin, yPos);
      yPos += 8;
      doc.text(`Responsáveis: ${responsibles.length}`, margin, yPos);
      yPos += 15;
      
      // Tabela de cursos
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text('Cursos do Lote:', margin, yPos);
      yPos += 10;
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      
      // Cabeçalhos da tabela (ajustados para modo retrato)
      const headers = ['ID', 'Tipologia', 'C.H.', 'Município', 'Cozinha', 'Status'];
      const colWidths = [18, 50, 18, 30, 35, 19];
      let xPos = margin;
      
      doc.setFont(undefined, 'bold');
      headers.forEach((header, i) => {
        doc.text(header, xPos, yPos);
        xPos += colWidths[i];
      });
      yPos += 8;
      
      // Linhas dos cursos
      doc.setFont(undefined, 'normal');
      lotCourses.forEach(course => {
        // Verifica se precisa de nova página
        if (yPos > doc.internal.pageSize.getHeight() - 30) {
          doc.addPage();
          yPos = margin;
        }
        
        xPos = margin;
        const rowData = [
          course.idCurso || '-',
          course.tipologia || '-',
          course.cargaHoraria ? `${course.cargaHoraria}h` : '-',
          course.municipio || '-',
          course.cozinha || '-',
          course.status || 'Pendente'
        ];
        
        rowData.forEach((data, i) => {
          // Ajustar tamanho do texto baseado na coluna (modo retrato)
          let maxLength = 1000; // Valor muito alto para não truncar por padrão
          if (i === 0) maxLength = 10; // ID
          else if (i === 1) maxLength = 30; // Tipologia - pode quebrar linha
          else if (i === 4) maxLength = 1000; // Cozinha - sem truncamento, pode quebrar linha
          else if (i === 3) maxLength = 20; // Município
          else if (i === 5) maxLength = 15; // Status
          
          let text = String(data);
          // Apenas truncar se exceder o limite (exceto para cozinha e tipologia que quebram linha)
          if (text.length > maxLength && maxLength < 100 && i !== 1 && i !== 4) {
            text = text.substring(0, maxLength - 3) + '...';
          }
          
          // Para tipologia e cozinha, quebrar linha se necessário
          if ((i === 1 || i === 4) && text.length > 20) {
            const lines = doc.splitTextToSize(text, colWidths[i] - 2);
            doc.text(lines, xPos, yPos);
            yPos += (lines.length - 1) * 5; // Ajustar altura se houver múltiplas linhas
          } else {
            doc.text(text, xPos, yPos);
          }
          xPos += colWidths[i];
        });
        yPos += 7;
      });
      
      // Responsáveis
      if (responsibles.length > 0) {
        yPos += 10;
        if (yPos > doc.internal.pageSize.getHeight() - 50) {
          doc.addPage();
          yPos = margin;
        }
        
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Responsáveis:', margin, yPos);
        yPos += 10;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        responsibles.forEach(resp => {
          if (yPos > doc.internal.pageSize.getHeight() - 30) {
            doc.addPage();
            yPos = margin;
          }
          doc.text(`${resp.name} - ${resp.cargo}`, margin, yPos);
          yPos += 7;
        });
      }
      
      // Salvar PDF
      doc.save(`Lote-${lotNumber}-${new Date().toISOString().split('T')[0]}.pdf`);
    }
  </script>
</body>
</html>
